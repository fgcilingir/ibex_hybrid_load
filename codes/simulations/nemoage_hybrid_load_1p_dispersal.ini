################################################################################
# Hybridization load simulations
################################################################################
# Description:
#   - Two populations (ibex and goats, patch_number = 2) with different carrying capacities.
#   - Slower recovery for patch 1 (ibex) and 174 high-impact mutations and 1450 deleterious mutations
#     randomly distributed accross 29 chromosomes, larger population for patch 2 (goats).
#   - Age-structured demography with polygynous mating.
#   - Deleterious variants based on Grossen et al. (2020)–like settings, with
#     effects supplied explicitly via delet_effects file.
#   - 1% dispersal during a short window (g10021-g10030)
# 
# Required files:
#   - delet_effects.txt
#
# Usage:
#   nemo nemoage_hybrid_load_1p_dispersal.ini
##
# Author: Gözde Cilingir
# Last Updated: December 2025
###############################################################################
# RUN CONTROL
###############################################################################

run_mode     run
root_dir     hybrid_load_1p_dispersal
filename     hybrid_load

replicates   1
generations  10200

###############################################################################
# POPULATIONS
###############################################################################

patch_number   2

patch_capacity (@g0     {{1000, 5000}},
                @g10000 {{ 500, 5000}},
                @g10005 {{  80, 5000}},
                @g10010 {{ 500, 5000}})

###############################################################################
# AGE STRUCTURE & DEMOGRAPHY
###############################################################################

# pop_transition_by_age = 1: transitions only at maximal age of an age class.
pop_transition_by_age 1

# Age classes (in years):
#   0, 1, 2, 3–5, 6–10, 11–14, 15–20
pop_age_structure {{0, 1, 2, 3, 6, 11, 15}}

# Population transition matrix:
pop_transition_matrix {{
    0,   0,    0.35, 0.60, 0.65, 0.50, 0.50,
    0.60,0,    0,    0,    0,    0,    0,    # survival of offspring
    0,   0.90, 0,    0,    0,    0,    0,
    0,   0,    0.99, 0,    0,    0,    0,
    0,   0,    0,    0.99, 0,    0,    0,
    0,   0,    0,    0,    0.93, 0,    0,
    0,   0,    0,    0,    0,    0.78, 0.55  # average survival of both sexes in oldest classes
}}

###############################################################################
# MATING / BREEDING
###############################################################################

# Mating system:
#   2 = polygyny
mating_system      2

# Number of males available for mating (per patch) over time:
mating_males (@g0     {{100, 500}},
              @g10000 {{ 50, 500}},
              @g10005 {{  8, 500}},
              @g10010 {{ 50, 500}})

# Proportion of females that mate successfully
mating_proportion  0.9

###############################################################################
# LIFE CYCLE EVENTS
###############################################################################

# Order of life cycle events within a generation:
#   1: breeding
#   2: viability selection
#   3: dispersal
#   4: density regulation
#   5: statistics
#   6: aging
#   7: file output
breed              1
viability_selection 2
disperse           3
regulation         4
save_stats         5
aging_multi        6
save_files         7

###############################################################################
# DISPERSAL
###############################################################################

# Age classes that can disperse (here: age classes 2 and 3).
dispersal_stage {{2, 3}}

# Dispersal model:
#   1 = migrant-pool island model
dispersal_model 1

# Dispersal matrix through time:
#   - Identity (no dispersal) except during a short window where patch2
#     sends migrants to patch1.
dispersal_matrix (@g0     {{1,   0}
                            {0,   1}},
                  @g10021 {{1,   0}
                            {0.01,0.99}},
                  @g10030 {{1,   0}
                            {0,   1}})

###############################################################################
# REGULATION (DENSITY DEPENDENCE)
###############################################################################

# Regulation according to carrying capacity (stochastic).
regulation_carrying_capacity

###############################################################################
# NEUTRAL GENETIC VARIATION
###############################################################################

ntrl_loci                 500
ntrl_all                  2
ntrl_random_genetic_map {{rep(200,29)}}
ntrl_mutation_rate        5e-05
ntrl_recombination_rate   0.5
ntrl_mutation_model       1
ntrl_init_patch_freq      {{0.0014}}  # initial allele frequency

# Output neutral allele frequencies per locus.
ntrl_save_freq
ntrl_output_dir           ntrl_freq

# Times (generations) at which neutral stats are recorded.
ntrl_output_logtime {{
    9000, 10000,
    seq(10005, 10010, 1),
    seq(10020, 10025, 1),
    10030, 10035, 10040, 10060, 10080,
    10100, 10120, 10140, 10160, 10180, 10200
}}

###############################################################################
# SELECTION
###############################################################################

selection_model          direct
selection_trait          delet
selection_fitness_model  absolute

###############################################################################
# DELETERIOUS VARIANTS
###############################################################################

# Deleterious loci, largely following Grossen et al. (2020)-like settings.
delet_loci                1624
delet_mutation_rate       5e-05
delet_backmutation_rate   5e-07
delet_init_freq           0.0014     
delet_mutation_model      1          
delet_fitness_model       1

# Per-locus effects are given explicitly:
#   - File contains selection coefficients and dominance values,
#     including 174 high-impact (LOF-like) mutations.
delet_effects &delet_effects.txt

# Deleterious mutations are randomly distributed accross 29 chromosoes, each 200cM in length
delet_random_genetic_map {{rep(200,29)}}

# Genotype output for deleterious loci.
delet_genot_dir       delet_genot
delet_save_genotype   1
delet_genot_logtime {{
    9000, 10000,
    seq(10005, 10010, 1),
    seq(10020, 10025, 1),
    10030, 10035, 10040, 10060, 10080,
    10100, 10120, 10140, 10160, 10180, 10200
}}

###############################################################################
# SUMMARY STATISTICS
###############################################################################

stat_dir         stats

# Logging interval for statistics:
#   - Every 200 generations from start (g0)
#   - Every 10 generations from g10000 onwards
stat_log_time (@g0     200,
               @g10000 10)

# Statistics to record:
#   - demography: population sizes, etc.
#   - delet: deleterious load-related summaries
#   - fstat, fstWC: genetic differentiation metrics
#   - viability: survival
#   - fitness.patch: patch-level fitness summaries
stat demography delet fstat fstWC viability fitness.patch

stat_output_compact
stat_output_CSV